#include "include/hashkey.h"
#include "include/chess.h"
#include "include/utils.h"
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>

const uint64_t HASHTABLE[12][64] = {
  {3566623202ULL, 2210514145ULL, 1614465847ULL, 692918632ULL,  4281325224ULL, 232702253ULL,
   71112635ULL,   1168668362ULL, 3006150408ULL, 347639644ULL,  3434634103ULL, 3125116039ULL,
   3376098275ULL, 3310677953ULL, 3052226155ULL, 199837609ULL,  2604879236ULL, 3609150253ULL,
   4270130187ULL, 2347706918ULL, 2633693440ULL, 2901662224ULL, 941611809ULL,  3649568047ULL,
   171059438ULL,  3348975257ULL, 2234610095ULL, 565758377ULL,  618370887ULL,  1221478755ULL,
   940990417ULL,  1224059249ULL, 2699065380ULL, 856898626ULL,  3868297348ULL, 1532293753ULL,
   4024208741ULL, 3691798377ULL, 312908112ULL,  2310646934ULL, 668907273ULL,  1599827858ULL,
   2522719132ULL, 370839061ULL,  630083952ULL,  286636848ULL,  2914481880ULL, 1830163230ULL,
   708882801ULL,  1000929935ULL, 930950953ULL,  2454384531ULL, 363326671ULL,  1654505606ULL,
   371850922ULL,  2839083313ULL, 3610119670ULL, 2346431088ULL, 2378859578ULL, 2925502773ULL,
   3201012720ULL, 2903505203ULL, 1560824012ULL, 482845227ULL},
  {1579338922ULL, 2968923970ULL, 2874472972ULL, 310940666ULL,  3037049831ULL, 890422882ULL,
   2162759675ULL, 2223923154ULL, 2557739735ULL, 3327920169ULL, 3915152694ULL, 3596750406ULL,
   3084302724ULL, 655565307ULL,  976840657ULL,  4148341049ULL, 3725233507ULL, 2620127963ULL,
   70100059ULL,   4002522653ULL, 3998982551ULL, 3810008085ULL, 1323692820ULL, 2801205483ULL,
   3149973750ULL, 2738644757ULL, 62028976ULL,   867096233ULL,  1884512884ULL, 2963891927ULL,
   2804997968ULL, 1553670252ULL, 2908273012ULL, 3847495983ULL, 1823567935ULL, 2318184980ULL,
   2746753266ULL, 866513623ULL,  598498879ULL,  34930162ULL,   660839621ULL,  2277151167ULL,
   3098492844ULL, 1430148874ULL, 393054101ULL,  385170353ULL,  1234922530ULL, 3125603708ULL,
   2153660609ULL, 99190880ULL,   115959987ULL,  2781186300ULL, 3453345480ULL, 1493055599ULL,
   1308073890ULL, 2573821675ULL, 4018037863ULL, 396457070ULL,  3475395433ULL, 1377597253ULL,
   1305653862ULL, 1644807893ULL, 3930660942ULL, 2220867253ULL},
  {3750836247ULL, 3500959159ULL, 176890497ULL,  1662174095ULL, 1809895757ULL, 3410045510ULL,
   1392065151ULL, 1315217570ULL, 3384374790ULL, 1406830108ULL, 3229373455ULL, 4293732924ULL,
   1602017479ULL, 3561728937ULL, 3370958347ULL, 3668300545ULL, 2131298097ULL, 2159991704ULL,
   3258614617ULL, 1857094191ULL, 1384149309ULL, 1125318832ULL, 3094444624ULL, 1797534771ULL,
   3621015532ULL, 1768634557ULL, 3551176898ULL, 652050946ULL,  2241426637ULL, 1433302168ULL,
   613110507ULL,  3581119731ULL, 1017683981ULL, 832578338ULL,  4047637569ULL, 3433483203ULL,
   920218126ULL,  1004121333ULL, 1094965700ULL, 3800652390ULL, 2922305283ULL, 2980008735ULL,
   3176887243ULL, 710582178ULL,  3395597081ULL, 2502371767ULL, 3449644153ULL, 2496990289ULL,
   113232414ULL,  3998016134ULL, 876879803ULL,  4256153361ULL, 794419712ULL,  1764570122ULL,
   366917141ULL,  392610245ULL,  2330054361ULL, 1296906956ULL, 1166293423ULL, 2326264382ULL,
   3421489699ULL, 564488223ULL,  877785886ULL,  3788178403ULL},
  {1474673712ULL, 167244053ULL,  3902822800ULL, 1797917533ULL, 890619591ULL,  827730149ULL,
   3497011093ULL, 1597609832ULL, 574343848ULL,  1716996070ULL, 2013992485ULL, 324276011ULL,
   831281231ULL,  322678232ULL,  2160370107ULL, 521663271ULL,  2132928752ULL, 2480914128ULL,
   1269554271ULL, 3618030913ULL, 448357478ULL,  1344745630ULL, 1073688540ULL, 2423218147ULL,
   3031166478ULL, 1080053231ULL, 836343915ULL,  1563321695ULL, 2003057548ULL, 1541586986ULL,
   2295408768ULL, 1661353915ULL, 1664583555ULL, 1152963373ULL, 2164674171ULL, 4143523147ULL,
   3089180261ULL, 3075148767ULL, 3718510455ULL, 1055977168ULL, 1992403841ULL, 2145917113ULL,
   3517122428ULL, 746881963ULL,  3456828553ULL, 3586905842ULL, 277570029ULL,  374397190ULL,
   3211883332ULL, 3337205742ULL, 3439342954ULL, 3784754488ULL, 624014138ULL,  3362069530ULL,
   797138156ULL,  2435489183ULL, 257947280ULL,  1820458754ULL, 2092999609ULL, 4245572729ULL,
   3156625380ULL, 1953227570ULL, 3550210645ULL, 3810310923ULL},
  {3181010069ULL, 2000392037ULL, 4023067223ULL, 2988314860ULL, 3310250569ULL, 3192884611ULL,
   99056410ULL,   3796507487ULL, 1470354149ULL, 3347103378ULL, 1829408281ULL, 3348892255ULL,
   2555366912ULL, 2578892039ULL, 271645435ULL,  80552825ULL,   2224413000ULL, 995199747ULL,
   941680583ULL,  2169343580ULL, 3562265179ULL, 2747392521ULL, 916415890ULL,  1119701256ULL,
   2924630352ULL, 1156023838ULL, 467574682ULL,  2257833910ULL, 199426684ULL,  1146618851ULL,
   3609064608ULL, 1259079852ULL, 220882120ULL,  4236469690ULL, 2755620043ULL, 2601465558ULL,
   1048171686ULL, 1350366097ULL, 289544581ULL,  1960107325ULL, 389423816ULL,  2095477755ULL,
   1116058258ULL, 2691485356ULL, 1251914720ULL, 289891035ULL,  2080433180ULL, 1688375291ULL,
   3773073728ULL, 2847844314ULL, 1837157503ULL, 3188907784ULL, 3964351057ULL, 2017545798ULL,
   3773571067ULL, 1288635754ULL, 1916091380ULL, 1401670107ULL, 2443611736ULL, 1328587692ULL,
   2694988158ULL, 2710889115ULL, 4251358017ULL, 635967877ULL},
  {3259802226ULL, 1385607053ULL, 1529633497ULL, 1872938226ULL, 1803218015ULL, 1008833142ULL,
   57189507ULL,   1658362008ULL, 2319405603ULL, 435921794ULL,  4120246385ULL, 2680258429ULL,
   3429998859ULL, 2142248236ULL, 4288769965ULL, 3201056133ULL, 329411923ULL,  1004693638ULL,
   3768472751ULL, 3542222425ULL, 2634545156ULL, 2030501308ULL, 2962490035ULL, 2998074166ULL,
   3463940507ULL, 239454865ULL,  1814125062ULL, 1902780944ULL, 164186075ULL,  2369768567ULL,
   3550737379ULL, 3189565842ULL, 2924423301ULL, 2692201967ULL, 367806498ULL,  1932259905ULL,
   1241752421ULL, 1213496562ULL, 2656231255ULL, 1677855739ULL, 754693657ULL,  258196736ULL,
   2035142839ULL, 866152505ULL,  3237583422ULL, 3447609175ULL, 1205691241ULL, 2430781696ULL,
   2123496355ULL, 952116405ULL,  281522064ULL,  2291926180ULL, 3039986468ULL, 2520684941ULL,
   3222429905ULL, 3453417492ULL, 2587608292ULL, 2321617547ULL, 106359830ULL,  507941343ULL,
   861516983ULL,  864932830ULL,  790863212ULL,  840554259ULL},
  {612527715ULL,  3566866759ULL, 48473042ULL,   1747871911ULL, 610102155ULL,  2442098258ULL,
   1509341374ULL, 3358535409ULL, 3423063651ULL, 3204066608ULL, 2905197559ULL, 3450701069ULL,
   968118717ULL,  4289527435ULL, 3702595521ULL, 3382969849ULL, 2514414290ULL, 3162747524ULL,
   3714291291ULL, 4075318413ULL, 1094539558ULL, 3734659359ULL, 1928837276ULL, 4289776206ULL,
   845628838ULL,  1703372461ULL, 438760539ULL,  3733365107ULL, 4228474016ULL, 1877458033ULL,
   3071382278ULL, 3041280145ULL, 3768472295ULL, 193585903ULL,  271264635ULL,  206861979ULL,
   2292363132ULL, 1011059532ULL, 3206529510ULL, 683339981ULL,  887297555ULL,  2362810167ULL,
   601499123ULL,  3544667507ULL, 1408781332ULL, 1052597325ULL, 4042584285ULL, 492077431ULL,
   3507200438ULL, 3626389309ULL, 3210005779ULL, 1988394379ULL, 1945667482ULL, 2084601822ULL,
   2270795163ULL, 271187800ULL,  361738620ULL,  2218830948ULL, 1152401722ULL, 2198830850ULL,
   2145661928ULL, 488881225ULL,  3878316453ULL, 2235667565ULL},
  {2743809433ULL, 327355743ULL,  1817530813ULL, 269567282ULL,  4009876877ULL, 3954873559ULL,
   3615772019ULL, 2550830834ULL, 3575521401ULL, 2063345692ULL, 2646326017ULL, 4033879675ULL,
   2666871259ULL, 1915917831ULL, 2338643380ULL, 2722720225ULL, 4129842387ULL, 255689146ULL,
   702192239ULL,  569873714ULL,  2553621884ULL, 2524299263ULL, 3291856147ULL, 14204437ULL,
   2871224099ULL, 870673349ULL,  2891360986ULL, 3133805825ULL, 462184811ULL,  1034059304ULL,
   4254782237ULL, 4174734782ULL, 821578379ULL,  3640274754ULL, 661385553ULL,  3926285358ULL,
   2800112650ULL, 1292510988ULL, 3209631420ULL, 3259006537ULL, 2643820032ULL, 161698077ULL,
   2173232829ULL, 3480921840ULL, 2564881047ULL, 1729970601ULL, 3197993179ULL, 2059730366ULL,
   2811367450ULL, 3075290270ULL, 1476736096ULL, 626169640ULL,  3564368592ULL, 3584104326ULL,
   4140060977ULL, 3336245792ULL, 3854291426ULL, 720186978ULL,  2077537237ULL, 1718503076ULL,
   1746928611ULL, 4146564624ULL, 382177587ULL,  773271317ULL},
  {475351671ULL,  875119683ULL,  2600701673ULL, 1043666971ULL, 1652304471ULL, 851922535ULL,
   3569257117ULL, 4075648756ULL, 3483166985ULL, 687290150ULL,  2648838263ULL, 2805237780ULL,
   1552352944ULL, 2133482726ULL, 864483710ULL,  3918994524ULL, 925733492ULL,  2435453195ULL,
   4121451288ULL, 1484698169ULL, 583249430ULL,  522127903ULL,  3881604077ULL, 4290965555ULL,
   3519094620ULL, 3936316978ULL, 3897211793ULL, 3769096354ULL, 4615510ULL,    108683178ULL,
   4095603390ULL, 524837165ULL,  2945111947ULL, 2286108985ULL, 1697340250ULL, 724564570ULL,
   866179974ULL,  2872296205ULL, 1504313839ULL, 1641883947ULL, 3183191735ULL, 2313191829ULL,
   2396196517ULL, 4083977215ULL, 861436503ULL,  1305499352ULL, 998634243ULL,  4216940846ULL,
   678277687ULL,  2422886016ULL, 309946607ULL,  732958275ULL,  559221849ULL,  2267895497ULL,
   3560410704ULL, 1402832322ULL, 1044468730ULL, 420821207ULL,  2628926380ULL, 3898412411ULL,
   1951244563ULL, 979454574ULL,  1536258370ULL, 4060063056ULL},
  {1335746107ULL, 3159642798ULL, 1220111353ULL, 2262957957ULL, 1663467070ULL, 23116803ULL,
   3060735504ULL, 1766529421ULL, 3237768295ULL, 3691235300ULL, 2524677825ULL, 3047862909ULL,
   1749498031ULL, 3522075264ULL, 2847728572ULL, 214158647ULL,  3272508318ULL, 997791074ULL,
   2509432915ULL, 1736920512ULL, 145650993ULL,  171381474ULL,  751456416ULL,  2113959427ULL,
   827570058ULL,  3984020388ULL, 1221857907ULL, 4162777148ULL, 1823732921ULL, 1709659557ULL,
   1929929766ULL, 674535536ULL,  2754918673ULL, 2336247602ULL, 3997909267ULL, 27313231ULL,
   3592554454ULL, 3309736634ULL, 971698788ULL,  831038484ULL,  2442143657ULL, 2859905096ULL,
   2132860246ULL, 3921651748ULL, 3468985032ULL, 709387062ULL,  799594907ULL,  4061464351ULL,
   1978666733ULL, 2044348606ULL, 2438934641ULL, 2290009638ULL, 3950478765ULL, 680092012ULL,
   32313622ULL,   929585626ULL,  813737708ULL,  2483220355ULL, 2246067543ULL, 22161997ULL,
   1666373648ULL, 1006869966ULL, 2528744356ULL, 2694924669ULL},
  {655944421ULL,  830465956ULL,  866841742ULL,  1670583205ULL, 1275603479ULL, 2826828212ULL,
   1554852305ULL, 2119168053ULL, 2742798655ULL, 853445307ULL,  1625566247ULL, 1004302119ULL,
   1289698293ULL, 1974048724ULL, 2743979989ULL, 2065012488ULL, 821854360ULL,  3235477985ULL,
   596549069ULL,  3301755319ULL, 2916046618ULL, 1696237828ULL, 1240658734ULL, 1926127443ULL,
   1312013031ULL, 1459197953ULL, 3412825238ULL, 4216214430ULL, 3797061807ULL, 2921473861ULL,
   3042182557ULL, 432795780ULL,  4292136230ULL, 1899109077ULL, 1746159783ULL, 2941417797ULL,
   1934596146ULL, 3742614983ULL, 3305687623ULL, 687332951ULL,  494198277ULL,  3233511410ULL,
   1542318385ULL, 277676752ULL,  1003220601ULL, 2898039790ULL, 842004295ULL,  1665776866ULL,
   713119353ULL,  39965957ULL,   3937777531ULL, 2801781479ULL, 2402379505ULL, 3220936903ULL,
   199731639ULL,  1698291708ULL, 3718504296ULL, 2205760571ULL, 2567969164ULL, 1073289899ULL,
   132844045ULL,  3898072524ULL, 954486621ULL,  1748935224ULL},
  {3269304818ULL, 1783069891ULL, 3807219389ULL, 79866348ULL,   2586347533ULL, 3914298427ULL,
   4176246488ULL, 1968888294ULL, 1741545038ULL, 149936974ULL,  1670626858ULL, 1415595608ULL,
   1927368167ULL, 4138828174ULL, 2228616154ULL, 499178418ULL,  1268667561ULL, 566133779ULL,
   1274919959ULL, 1409014493ULL, 3681188910ULL, 431086217ULL,  882894902ULL,  3231425291ULL,
   2782667846ULL, 3328293325ULL, 511104458ULL,  1416136607ULL, 2542398841ULL, 844028886ULL,
   1267975173ULL, 2678343268ULL, 3627529864ULL, 3359244995ULL, 1168621316ULL, 771633391ULL,
   193253706ULL,  3103845892ULL, 3894452295ULL, 3496300233ULL, 3304454993ULL, 1430407880ULL,
   2649635194ULL, 3790223135ULL, 1665715712ULL, 3965747433ULL, 2519256071ULL, 3290808125ULL,
   2105888402ULL, 1491808165ULL, 1818879747ULL, 1172825893ULL, 1568220904ULL, 3989533821ULL,
   222742836ULL,  4207968613ULL, 1277402953ULL, 2640255143ULL, 3976394691ULL, 2652556260ULL,
   1393142757ULL, 1659313936ULL, 1251157886ULL, 1222308062ULL}};

uint64_t hashkey_position(Position* position) {
    uint64_t hash           = 0ULL;
    uint64_t piece_bitmap   = 0ULL;
    uint8_t  piece_hash_idx = 0;
    uint8_t  piece_pos      = 0;

    for (uint8_t p = 1; p < 15; p++)
    {
        if (p == BOARD_WHITE_PIECES_IDX || p == BOARD_BLACK_PIECES_IDX)
        {
            continue;
        }

        piece_bitmap   = position->board.bitboards[p];
        piece_hash_idx = HASH_IDX(p);

        while (piece_bitmap)
        {
            piece_pos = utils_bit_bitscan_forward(&piece_bitmap);
            hash ^= HASHTABLE[piece_hash_idx][piece_pos];
        }
    }

    return hash;
}
